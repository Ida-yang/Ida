<template>
<!-- 盘点单 -->
    <div>
        <div class="searchList" @keyup.enter="search()">
            <el-input v-model="searchList.orderNum" placeholder="单号"></el-input>
        </div>
        <div class="searchList">
            <el-select
                @change="search()"
                v-model="searchList.status"
                placeholder="状态">
                <el-option
                v-for="item in statusList"
                :key="item.id"
                :label="item.value"
                :value="item.id">
                </el-option>
            </el-select>
        </div>
        <div class="searchList">
            <el-select
                collapse-tags
                @change="search()"
                v-model="searchList.idCk"
                placeholder="仓库">
                <el-option
                v-for="item in warehouseList"
                :key="item.ckId"
                :label="item.ckName"
                :value="item.ckId">
                </el-option>
            </el-select>
        </div>
        <!-- <div class="searchList" @keyup.enter="search()">
            <el-input v-model="searchList.ckName" placeholder="仓库"></el-input>
        </div> -->
        <el-button type="success" size="mini" @click="search()">查询</el-button>
        <el-button type="info" size="mini" @click="clear()">清空</el-button>

        <el-table
            :data="tableData"
            :max-height="maxheight"
            border
            style="width: 100% ;text-align: center;margin-top:10px">
            <el-table-column
                prop="orderNum"
                label="盘点单号"
                header-align="center"
                align="center"
                width="160">
                <template slot-scope="scope">
                    <el-button
                    size="mini"
                    style="border:none;color:#3c8dbc"
                    @click="CheckTheDetails(scope.$index, scope.row)">{{ scope.row.orderNum }}</el-button>
                </template>
            </el-table-column>
            <el-table-column
                prop="status"
                label="状态"
                header-align="center"
                align="center"
                width="100">
                <template slot-scope="scope">
                    <el-tag close-transition>{{scope.row.status | formatStatus}}</el-tag>
                </template>
            </el-table-column>
            <el-table-column
                prop="idCk"
                label="仓库"
                header-align="center"
                align="center"
                width="160">
                <template slot-scope="scope">
                    {{ scope.row.ck.ckName }}
                </template>
            </el-table-column>
            <el-table-column
                prop="operator"
                label="操作用户"
                header-align="center"
                align="center"
                width="100">
            </el-table-column>
            <el-table-column
                prop="getUserName"
                header-align="center"
                align="center"
                label="拉取单据用户"
                width="120">
            </el-table-column>
            <el-table-column
                prop="createtime"
                header-align="center"
                align="center"
                label="创建时间"
                width="180">
            </el-table-column>
            <el-table-column
                prop="updatetime"
                header-align="center"
                align="center"
                label="更新时间"
                width="180">
            </el-table-column>
            <el-table-column label="操作"
                width="100"
                header-align="center"
                align="center">
                <template slot-scope="scope">
                    <el-button
                    size="mini"
                    type="danger"
                    @click="handleDelete(scope.$index, scope.row)">删除</el-button>
                </template>
            </el-table-column>
        </el-table>
        <div class="block numberPage">
            <el-pagination
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
            :current-page="recentPage"
            :page-sizes="[10, 15, 20, 25]"
            :page-size="10"
            layout="total, sizes, prev, pager, next, jumper"
            :total="tableNumber">
            </el-pagination>
        </div>
    </div>
</template>
<style>
    .numberPage{
        text-align: right;
        position: relative;
        top: 0;
        background-color: #fff;
        width: 100%;
    }
    .el-dialog__body {
        padding: 30px 80px 30px 20px !important;
        color: #606266;
        font-size: 14px;
    }
    .el-table td, .el-table th {
        padding: 6px 0 !important;
        line-height: 30px;
    }
    .el-input__inner {
        height: 30px;
        line-height: 30px;
        width: 100%;
    }
    .el-table {
        font-size: 12px!important;
    }
    .el-table td, .el-table th {
        padding: 8px 0;
        line-height:30px; 
    }
</style>

<script>
    import store from '../../../../store/store'
    import axios from 'axios'
    export default {
        name:'InventoryOrder',
        computed: {
            tableData(){
                return store.state.inventoryOrderList;
            },
            tableNumber(){
               return store.state.inventoryOrderListnumber;     
            },
            Height(){
                return store.state.maxheight;
            },
        },
        filters: {
            formatStatus: function (val) {
                return val == 0 ? '未盘点' : val== 1 ?  '已提交' : "未知状态";
            },
        },
        props:{
            totalNum:Number,
        },
        store,
        data(){
            return {
                searchList:{
                    orderNum: null,
                    status: null,
                    idCk: null,
                },
                statusList: [//状态
                    {id:"0", value:"未盘点"},
                    {id:"1", value:"已提交"},
                ],
                warehouseList: null,
                recentPage:1,//默认第一页
                recordCount:10,//默认10条
                maxheight:null,
            }
        },
        mounted() {
            this.reloadTable();
            this.loadWarehouse();
            let _this=this;
            _this.$store.commit("getMaxHeight")
            _this.maxheight = _this.Height;
        },
        methods: {
            reloadTable(flag) {
                let _this = this;
                let searchList = {}
                if(flag) {
                    if(_this.searchList.orderNum) {
                        searchList.orderNum = _this.searchList.orderNum;
                    }
                    if(_this.searchList.status) {
                        searchList.status = _this.searchList.status;
                    }
                    if(_this.searchList.idCk != null) {
                        searchList.idCk = _this.searchList.idCk;
                    }
                }
                axios({
                    method: 'post',
                    url: _this.$store.state.defaultHttp+_this.$store.state.inventoryOrderUrl+'getByPage?recentPage='+_this.recentPage+'&recordCount='+_this.recordCount,
                    data: JSON.stringify(searchList),
                }).then(function(res){
                    _this.$store.state.inventoryOrderList = res.data.result.records;
                    _this.$store.state.inventoryOrderListnumber = res.data.result.totalRecords;
                    
                }).catch(function(err){
                    console.log(err);
                });
            },
            loadWarehouse() {
                let _this = this;
                axios({
                    method: 'post',
                    url: _this.$store.state.defaultHttp+_this.$store.state.warehouseUrl+'webAddStorageSelectAll',
                }).then(function(res){
                    _this.warehouseList = res.data.result;
                    _this.warehouseListnumber = res.data.result.length;
                }).catch(function(err){
                })
            },
            search() {
                this.$options.methods.reloadTable.bind(this)(true);
            },
            clear() {
                this.searchList.orderNum = null;
                this.searchList.status = null;
                this.searchList.idCk = null;
                this.$options.methods.reloadTable.bind(this)(true);
            },
            handleSizeChange(val) {
                let _this = this;
                _this.recordCount = val;
                _this.$options.methods.reloadTable.bind(_this)();
            },
            handleCurrentChange(val) {
                let _this = this;
                _this.recentPage = val;
                _this.$options.methods.reloadTable.bind(_this)();
            },
            handleDelete(index, row) {
                let _this = this;
                _this.$confirm('是否确认删除盘点单[' + row.orderNum + ']？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                }).then(({ value }) => {
                    axios({
                        method: 'get',
                        url: _this.$store.state.defaultHttp+_this.$store.state.inventoryOrderUrl+'delete?id=' + row.id,
                    }).then(function(res){
                        if(res.data.code && res.data.code == 200) {
                            _this.$message({
                                message: '删除盘点单成功',
                                type: 'success'
                            });
                            _this.$options.methods.reloadTable.bind(_this)(false);
                        } else {
                            _this.$message({
                                message: res.data.message,
                                type: 'error'
                            });
                        }
                    }).catch(function(err){
                        // console.log(err);
                    })
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '取消删除单据[' + row.orderNum + ']'
                    });       
                });
            },
            CheckTheDetails(index, row){
                this.$store.state.inventoryOrderId = ""
                this.$store.state.inventoryOrderId = row.id;
                this.$router.push({ path: '/InventoryOrderDetail' })
            },
            rowClick(row, event, column) {
                this.$options.methods.CheckTheDetails.bind(this)(null, row);
            }
        },
        
    }
</script>
