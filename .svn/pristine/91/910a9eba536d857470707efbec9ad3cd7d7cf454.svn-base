<template>
    <div>
        <div class="grid-content">
            <el-button type="primary" size="small" @click="handleAdd()">
                新增用户
            </el-button>
        </div>
        <div class="searchList" @keyup.enter="search()">
            <el-input v-model="searchList.enterpriseNumber" placeholder="用户ID"></el-input>
        </div>
        <div class="searchList" @keyup.enter="search()">
            <el-input v-model="searchList.username" placeholder="用户名称"></el-input>
        </div>
        <div class="searchList" @keyup.enter="search()">
            <el-input v-model="searchList.account" placeholder="用户账号"></el-input>
        </div>
        <el-button type="success" size="mini" @click="search()">查询</el-button>
        <el-button type="info" size="mini" @click="clear()">清空</el-button>

        <el-table
            :data="userTableData"
            :max-height="maxheight"
            border
            style="width: 100% ;text-align: center ;margin-top:10px;">
            <el-table-column
                header-align="center"
                align="center"
                prop="enterpriseNumber"
                label="用户ID"
                width="200"
                >
            </el-table-column>
            <el-table-column
                prop="username"
                label="用户名称"
                header-align="center"
                align="center"
                width="300">
            </el-table-column>
            <el-table-column
                prop="account"
                label="用户账号"
                header-align="center"
                align="center"
                width="180">
            </el-table-column>
            <el-table-column label="操作"
                width="280"
                header-align="center"
                align="center">
                <template slot-scope="scope">
                    <el-button
                    size="mini"
                    @click="handleEdit(scope.$index, scope.row)">编辑</el-button>
                    <el-button
                    size="mini"
                    type="primary"
                    @click="handleSetRoles(scope.$index, scope.row)">修改角色</el-button>
                    <el-button
                    size="mini"
                    type="danger"
                    @click="handleDelete(scope.$index, scope.row)">删除</el-button>
                </template>
            </el-table-column>
        </el-table>
        <div class="block numberPage">
            <el-pagination
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
            :current-page="recentPage"
            :page-sizes="[10, 15, 20, 25]"
            :page-size="10"
            layout="total, sizes, prev, pager, next, jumper"
            :total="tableNumber">
            </el-pagination>
        </div>
        <el-dialog title="新增用户" center :visible.sync="dialogFormVisible" width="47%" :modal="false">
            <el-form :model="newForm">
                <el-form-item label="用户ID" :label-width="formLabelWidth">
                    <el-input v-model="newForm.enterpriseNumber" auto-complete="off"></el-input>
                </el-form-item>
                <el-form-item label="用户名称" :label-width="formLabelWidth">
                    <el-input v-model="newForm.username" auto-complete="off"></el-input>
                </el-form-item>
                <el-form-item label="用户账号" :label-width="formLabelWidth">
                    <el-input v-model="newForm.account" auto-complete="off"></el-input>
                </el-form-item>
                <el-form-item label="用户密码" :label-width="formLabelWidth">
                    <el-input v-model="newForm.password" auto-complete="off"></el-input>
                </el-form-item>
                <el-form-item label="组织" :label-width="formLabelWidth">
                    <el-select
                        multiple
                        collapse-tags
                        v-model="newForm.orgArr"
                        placeholder="请选择组织"
                        style="width:100%">
                        <el-option
                        v-for="item in options"
                        :key="item.id"
                        :label="item.orgname"
                        :value="item.id">
                        </el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="dialogFormVisible = false">取 消</el-button>
                <el-button type="primary" @click="addUser">提 交</el-button>
            </div>
        </el-dialog>
        <el-dialog title="修改用户" center :visible.sync="dialogFormVisible1" width="47%" :modal="false">
            <el-form :model="updateFrom">
                <el-form-item label="用户ID" :label-width="formLabelWidth">
                    <el-input v-model="updateFrom.enterpriseNumber" auto-complete="off"></el-input>
                </el-form-item>
                <el-form-item label="用户名称" :label-width="formLabelWidth">
                    <el-input v-model="updateFrom.username" auto-complete="off"></el-input>
                </el-form-item>
                <el-form-item label="用户账号" :label-width="formLabelWidth">
                    <el-input v-model="updateFrom.account" auto-complete="off"></el-input>
                </el-form-item>
                <el-form-item label="用户密码" :label-width="formLabelWidth">
                    <el-input v-model="updateFrom.password" auto-complete="off"></el-input>
                </el-form-item>
                <el-form-item label="组织" :label-width="formLabelWidth">
                    <el-select
                        multiple
                        collapse-tags
                        v-model="updateFrom.orgArr"
                        value-key="id"
                        placeholder="请选择组织"
                        style="width:100%">
                        <el-option
                            v-for="item in options"
                            :key="item.id"
                            :label="item.orgname"
                            :value="item.id">
                        </el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="dialogFormVisible1 = false">取 消</el-button>
                <el-button type="primary" @click="updateUser" >提 交</el-button>
            </div>
        </el-dialog>
        <el-dialog center title="用户角色" :visible.sync="dialogFormVisible2" width="55%" :modal="false">
            <el-table
                :data="roleTableData.slice((recentPage2-1)*recordCount2,recentPage2*recordCount2)"
                ref="selectRoles"
                :max-height="maxheight"
                border
                style="text-align: center"
                :row-key="getRowKeys"
                @selection-change="handleSelectionChange">
                <el-table-column
                    type="selection"
                    header-align="center"
                    :reserve-selection="true"
                    prop="roleId"
                    width="55">
                </el-table-column>
                <el-table-column
                    prop="code"
                    label="角色编码"
                    header-align="center"
                    align="center"
                    width="120">
                </el-table-column>
                <el-table-column
                    prop="name"
                    header-align="center"
                    align="center"
                    label="角色名称"
                    width="200">
                </el-table-column>
            </el-table>
            <div class="block numberPage">
                <el-pagination
                    @size-change="handleSizeChange2"
                    @current-change="handleCurrentChange2"
                    :current-page="recentPage2"
                    :page-sizes="[10, 15, 20, 25]"
                    :page-size="10"
                    layout="total, sizes, prev, pager, next, jumper"
                    :total="tableNumber2">
                </el-pagination>
            </div>
            <div slot="footer" class="dialog-footer">
                <el-button @click="dialogFormVisible2 = false">取 消</el-button>
                <el-button type="primary" @click="updateRoles">提 交</el-button>
            </div>
        </el-dialog>
    </div>
</template>
<style>
    .numberPage{
        text-align: right;
        position: relative;
        top: 0;
        background-color: #fff;
        width: 100%;
    }
    .el-dialog__body {
        padding: 30px 80px 30px 20px !important;
        color: #606266;
        font-size: 14px;
    }
    .el-table td, .el-table th {
        padding: 6px 0 !important;
        line-height: 30px;
    }
    .btnSet{
        height: 40px;
    }
    .el-input__inner {
        height: 30px;
        line-height: 30px;
        width: 100%;
    }
    .el-table {
        font-size: 12px!important;
    }
    .el-table td, .el-table th {
        padding: 8px 0;
        line-height:30px; 
    }
    .el-dialog {
        margin-left: 250px;
    }
</style>

<script>
    import store from '../../../../store/store'
    import axios from 'axios'
    export default {
        name:'UserData',
        computed: {
            userTableData(){
                return store.state.userList;
            },
            tableNumber(){
               return store.state.userListnumber;     
            },
            options(){
                return store.state.organizationList;
            },
            roleTableData(){
                return store.state.rolesList;
            },
            tableNumber2(){
               return store.state.rolesListnumber;     
            },
            Height(){
                return store.state.maxheight;
            },
        },
        props:{
            totalNum:Number,
        },
        store,
        data(){
            return {
                searchList:{
                    enterpriseNumber: null,
                    username: null,
                    account: null,
                },
                recentPage:1,//默认第一页
                recordCount:10,//默认10条
                newForm:{
                    enterpriseNumber: null,
                    username: null,
                    account: null,
                    password: null
                },
                updateFrom:{
                    userId: null,
                    enterpriseNumber: null,
                    username: null,
                    account: null,
                    password: null,
                },
                rolesForm:{
                    userId: null,
                },
                dialogFormVisible: false,
                dialogFormVisible1: false,
                dialogFormVisible2: false,
                recentPage2: 1,
                recordCount2: 10,
                // 获取row的key值
                getRowKeys(row) {
                    return row.roleId;
                },
                maxheight:null,
                formLabelWidth: '120px'
            }
        },
        created(){
            this.reloadTable();
        },
        mounted(){
            var _this=this;
            _this.$store.commit("getMaxHeight")
            _this.maxheight = _this.Height;   
        },
        methods: {
            reloadTable(flag) {
                let _this = this;
                let searchList = {}
                if(flag) {
                    if(_this.searchList.enterpriseNumber) {
                        searchList.enterpriseNumber = _this.searchList.enterpriseNumber;
                    }
                    if(_this.searchList.username) {
                        searchList.username = _this.searchList.username;
                    }
                    if(_this.searchList.account) {
                        searchList.account = _this.searchList.account;
                    }
                }
                axios({
                    method: 'post',
                    url: _this.$store.state.defaultHttp+_this.$store.state.userUrl+'getByPage?recentPage='+_this.recentPage+'&recordCount='+_this.recordCount,
                    data: JSON.stringify(searchList),
                }).then(function(res){
                    if(res.data && res.data.code == 200) {
                        _this.$store.state.userList = res.data.result.records;
                        _this.$store.state.userListnumber = res.data.result.totalRecords;
                    } else {
                        _this.$message({
                            message: res.data.message,
                            type: 'error'
                        });
                    }
                }).catch(function(err){
                    // console.log(err);
                });
            },
            loadOrganization(row) {
                let _this = this;
                axios({
                    method: 'post',
                    url: _this.$store.state.defaultHttp+_this.$store.state.orgURL+'selectByCriteria',
                }).then(function(res){
                    if(row && row.orgArr) {
                        _this.newForm.orgArr = row.orgArr;
                    } else {
                        _this.newForm.orgArr = [];
                    }
                    _this.$store.state.organizationList = res.data.result.records;
                    _this.$store.state.organizationListnumber = res.data.result.totalRecords;
                }).catch(function(err){
                    // console.log(err);
                })
            },
            search() {
                this.$options.methods.reloadTable.bind(this)(true);
            },
            clear() {
                this.searchList.enterpriseNumber = null;
                this.searchList.username = null;
                this.searchList.account = null;
                this.$options.methods.reloadTable.bind(this)(true);
            },
            handleAdd() {
                let addOrUpdateData = {};
                this.$options.methods.loadOrganization.bind(this)();
                let options = this.$store.state.organizationList;
                addOrUpdateData.title = "新增用户";
                addOrUpdateData.createForm = [
                    {"label":"用户ID","inputModel":"enterpriseNumber"},
                    {"label":"用户名称","inputModel":"username"},
                    {"label":"用户账号","inputModel":"account"},
                    {"label":"用户密码","inputModel":"password"},
                    {
                        "label": "组织",
                        "inputModel": "orgArr",
                        "type": "select",
                        "okey": "id",
                        "ovalue": "id",
                        "olabel": "orgname",
                        "placeholder": "请选择组织",
                        "options": options,
                        "multiple": true
                    },
                ];
                addOrUpdateData.setForm = {
                    "enterpriseNumber": "",
                    "username": "",
                    "account": "",
                    "password": "",
                    "orgArr": ""};
                addOrUpdateData.submitURL = this.$store.state.defaultHttp+this.$store.state.userUrl +'add';
                this.$store.state.addOrUpdateData = addOrUpdateData;
                this.$router.push({ path: '/addOrUpdate' });
                // this.newForm.enterpriseNumber = null;
                // this.newForm.account = null; 
                // this.newForm.username = null;
                // this.newForm.password = null;
                // this.$options.methods.loadOrganization.bind(this)(null);
                // this.dialogFormVisible = true;
            },
            handleEdit(index, row) {
                let addOrUpdateData = {};
                this.$options.methods.loadOrganization.bind(this)();
                let options = this.$store.state.organizationList;
                addOrUpdateData.title = "修改用户 ["+ row.username +"]";
                addOrUpdateData.createForm = [
                    {"label":"用户ID","inputModel":"enterpriseNumber"},
                    {"label":"用户名称","inputModel":"username"},
                    {"label":"用户账号","inputModel":"account"},
                    {"label":"用户密码","inputModel":"password"},
                    {
                        "label": "组织",
                        "inputModel": "orgArr",
                        "type": "select",
                        "okey": "id",
                        "ovalue": "id",
                        "olabel": "orgname",
                        "placeholder": "请选择组织",
                        "options": options,
                        "multiple": true
                    },
                ];
                let orgArr = [];
                if( row.orgArr) {
                    row.orgArr.forEach(org => {
                        orgArr.push(org.orgId);
                    });
                    // orgArr = row.orgArr;
                }
                addOrUpdateData.setForm = {
                    "enterpriseNumber": row.enterpriseNumber,
                    "username": row.username,
                    "account": row.account,
                    "password": "",
                    "orgArr": orgArr};
                addOrUpdateData.submitData = {"userId": row.userId};
                addOrUpdateData.submitURL = this.$store.state.defaultHttp+this.$store.state.userUrl +'update';
                this.$store.state.addOrUpdateData = addOrUpdateData;
                this.$router.push({ path: '/addOrUpdate' });
                // this.updateFrom.userId = row.userId; 
                // this.updateFrom.enterpriseNumber = row.enterpriseNumber; 
                // this.updateFrom.account = row.account;
                // this.updateFrom.username = row.username; 
                // this.$options.methods.loadOrganization.bind(this)(row);
                // this.dialogFormVisible1 = true;
            },
            handleDelete(index, row) {
                let _this = this;
                _this.$confirm('是否确认删除用户[' + row.username + ']？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                }).then(({ value }) => {
                    axios({
                        method: 'get',
                        url: _this.$store.state.defaultHttp+_this.$store.state.userUrl+'changeStatus?userId=' + row.userId + "&status=100",
                    }).then(function(res){
                        if(res.data.code && res.data.code == 200) {
                            _this.$message({
                                message: '删除用户成功',
                                type: 'success'
                            });
                            _this.$options.methods.reloadTable.bind(_this)();
                        } else {
                            _this.$message({
                                message: res.data.message,
                                type: 'error'
                            });
                        }
                    }).catch(function(err){
                        // console.log(err);
                    })
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '取消删除用户[' + row.username + ']'
                    });       
                });
            },
            handleSizeChange(val) {
                let _this = this;
                _this.recordCount = val;
                _this.$options.methods.reloadTable.bind(_this)();
            },
            handleCurrentChange(val) {
                let _this = this;
                _this.recentPage = val;
                _this.$options.methods.reloadTable.bind(_this)();
            },
            addUser(){
                let _this = this;
                let mydata = {};
                let orgArr = [];
                mydata.enterpriseNumber = _this.newForm.enterpriseNumber;
                mydata.username = _this.newForm.username;
                mydata.account = _this.newForm.account;
                mydata.password = _this.newForm.password;
                if(_this.newForm.orgArr.length != 0) {
                    _this.newForm.orgArr.forEach(orgId => {
                        let org = {};
                        org.orgId = orgId;
                        orgArr.push(org);
                    });
                } else {
                    let org = {};
                    org.orgId = _this.$store.state.userData.orgId;
                    orgArr.push(org);
                }
                mydata.orgArr = orgArr;

                axios({
                    method: 'post',
                    url: _this.$store.state.defaultHttp+_this.$store.state.userUrl+'add',
                    data:JSON.stringify(mydata),
                }).then(function(res){
                    if(res.data.code && res.data.code == 200) {
                        _this.$message({
                            message: '新增用户成功',
                            type: 'success'
                        });
                        _this.dialogFormVisible = false;
                        _this.$options.methods.reloadTable.bind(_this)();
                    } else {
                        _this.$message({
                            message: res.data.message,
                            type: 'error'
                        })
                    }
                }).catch(function(err){
                    // console.log(err)
                })        
            },
            updateUser(){
                let _this = this;
                let mydata = {};
                let orgArr = [];
                mydata.userId = _this.updateFrom.userId;
                mydata.enterpriseNumber = this.updateFrom.enterpriseNumber;
                mydata.account = this.updateFrom.account;
                mydata.username = this.updateFrom.username;
                if(this.updateFrom.password && this.updateFrom.password != "") {
                    mydata.password = this.updateFrom.password;
                }
                if(_this.updateFrom.orgArr.length != 0) {
                    _this.updateFrom.orgArr.forEach(orgId => {
                        let org = {};
                        org.orgId = orgId;
                        orgArr.push(org);
                    });
                } else {
                    let org = {};
                    org.orgId = _this.$store.state.userData.orgId;
                    orgArr.push(org);
                }
                mydata.orgArr = orgArr;
                
                axios({
                    method: 'post',
                    url:  _this.$store.state.defaultHttp+ _this.$store.state.userUrl+'update',
                    data:JSON.stringify(mydata),
                }).then(function(res){
                    if(res.data.code && res.data.code == 200) {
                        _this.$message({
                            message: '修改用户信息成功',
                            type: 'success'
                        });
                        _this.dialogFormVisible1 = false;
                        _this.$options.methods.reloadTable.bind(_this)();
                    } else {
                        _this.$message({
                            message: res.data.message,
                            type: 'error'
                        });
                    }
                }).catch(function(err){
                    // console.log(err);
                });      
            },
            handleSetRoles(index, row) {
                let _this = this;
                axios({
                    method: 'post',
                    url: _this.$store.state.defaultHttp+_this.$store.state.roleUrl+'getall'
                }).then(function(res){
                    if(res.data && res.data.code == 200) {
                        _this.$store.state.rolesList = res.data.result;
                        let setOtherData = {};
                        setOtherData.title = "修改 ["+ row.username +"] 的角色";
                        setOtherData.setTable = [
                            {"head":"角色编号","body":"code"},
                            {"head":"角色名称","body":"name"},
                            {"head":"描述","body":"description"}];
                        setOtherData.tableData = _this.$store.state.rolesList;
                        setOtherData.selectData = row.authRoles;
                        setOtherData.submitDataId = null;
                        setOtherData.submitDataName = null;
                        setOtherData.identifier = "roleId";
                        setOtherData.submitURL = _this.$store.state.defaultHttp+_this.$store.state.userUrl+'setRoles?userId='+row.userId;
                        _this.$store.state.setOtherData = setOtherData;
                        _this.$router.push({ path: '/setRelationInfo' });
                    } else {
                        _this.$message({
                            message: res.data.message,
                            type: 'error'
                        });
                    }
                }).catch(function(err){
                    // console.log(err);
                });

                // let _this = this;
                // _this.dialogFormVisible2 = true;
                // _this.rolesForm.userId = row.userId;
                // axios({
                //     method: 'post',
                //     url: _this.$store.state.defaultHttp+_this.$store.state.roleUrl+'getall'
                // }).then(function(res){
                //     if(res.data && res.data.code == 200) {
                //         let result = res.data.result;
                //         _this.$store.state.rolesList = result;
                //         _this.$store.state.rolesListnumber = result.length;
                //         _this.$refs.selectRoles.clearSelection();
                //         _this.selectRoles = [];
                //         if(row.authRoles.length > 0) {
                //             result.forEach(allRole => {
                //                 row.authRoles.forEach(haveRole => {
                //                     if(allRole.roleId == haveRole.roleId) {
                //                         _this.$refs.selectRoles.toggleRowSelection(allRole);
                //                     }
                //                 });
                //             });
                //         }
                //     } else {
                //         _this.$message({
                //             message: res.data.message,
                //             type: 'error'
                //         });
                //     }
                    
                // }).catch(function(err){
                //     console.log(err);
                // });
            },
            handleSizeChange2(val) {
                this.recordCount2 = val;
            },
            handleCurrentChange2(val) {
                this.recentPage2 = val;
            },
            updateRoles() {
                let _this = this;
                let roles = [];
                _this.selectRoles.forEach(select => {
                    let role = {};
                    role.roleId = select.roleId;
                    role.code = select.code;
                    roles.push(role);
                });
                axios({
                    method: 'post',
                    url: _this.$store.state.defaultHttp+ _this.$store.state.userUrl+'setRoles?userId='+_this.rolesForm.userId,
                    data: JSON.stringify(roles)
                }).then(function(res){
                    if(res.data.code && res.data.code == 200) {
                        _this.$message({
                            message: '修改角色成功',
                            type: 'success'
                        });
                        _this.dialogFormVisible2 = false;
                        _this.$options.methods.reloadTable.bind(_this)();
                    } else {
                        _this.$message({
                            message: res.data.message,
                            type: 'error'
                        });
                    }
                }).catch(function(err){
                    // console.log(err);
                }); 
            },
            handleSelectionChange(rows) {
                this.selectRoles = [];
                if (rows) {
                    rows.forEach(row => {
                        if (row) {
                            this.selectRoles.push(row);
                        }
                    });
                }
            }
        },
        
    }
</script>
