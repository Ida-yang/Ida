<template>
    <div>
        <el-row>
            <el-col :offset="5" :xs="4" :sm="4" :md="4" :lg="4">
                <el-card :body-style="{ padding: '0px' }">
                    <img src="../../../../assets/image/serialType1.png" class="image">
                    <div style="padding: 14px;">
                        <div class="bottom clearfix">
                            <el-radio v-model="barcodeStyle"    label="1" style="margin-left:15%">样式一</el-radio>
                        </div>
                    </div>
                </el-card>
            </el-col>
            <el-col :offset="1" :xs="4" :sm="4" :md="4" :lg="4">
                <el-card :body-style="{ padding: '0px' }">
                    <img src="../../../../assets/image/serialType2.png" class="image">
                    <div style="padding: 14px;">
                        <div class="bottom clearfix">
                            <el-radio v-model="barcodeStyle" label="2" style="margin-left:15%">样式二</el-radio>
                        </div>
                    </div>
                </el-card>
            </el-col>
            <el-col :offset="1" :xs="4" :sm="4" :md="4" :lg="4">
                <el-card :body-style="{ padding: '0px' }">
                    <img src="../../../../assets/image/serialType3.png" class="image">
                    <div style="padding: 14px;">
                        <div class="bottom clearfix">
                            <el-radio v-model="barcodeStyle" label="3" style="margin-left:15%">样式三</el-radio>
                        </div>
                    </div>
                </el-card>
            </el-col>
            <el-col :offset="5" :xs="19" :sm="19" :md="19" :lg="19" style="height:52px!important">
                <div style="margin-top:3%;display: inline-block;">
                    <span>查  找 :</span>
                    <el-input v-model="selectInput" placeholder="序列号/编号/名称" style="width:50%;margin-left:17px;padding:0px;"></el-input>
                </div>  
                <div style="margin-top:3%;display: inline-block;">
                    <span >打印份数</span>
                    <el-input-number size="mini" v-model="copiesNum" :min="1"></el-input-number>
                </div>
            </el-col>
        </el-row>
        <el-table
            ref="multipleTable"
            :data="dataList.slice((currentPage-1)*pageSize,currentPage*pageSize)"
            tooltip-effect="dark"
            style="width: 90%;margin-left:5%"
            height="300"
            :row-key="getRowKeys"
            @selection-change="handleSelectionChange">
            <el-table-column
            type="selection"
            :reserve-selection="true"
            align="center"
            width="100">
            </el-table-column>
            <el-table-column
            prop="No"
            fixed="left"
            label="序列号"
            align="center"
            header-align="center"
            width="180">
            </el-table-column>
            <el-table-column
            prop="GNo"
            fixed="left"
            label="产品编号"
            align="center"
            header-align="center"
            width="220">
            </el-table-column>
            <el-table-column
            prop="Name"
            label="产品名称"
            align="center"
            header-align="center"
            width="220">
            </el-table-column>
        </el-table>
        <div class="block numberPage">
            <el-pagination
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
            :current-page="currentPage"
            :page-sizes="[10, 15, 25, 50]"
            :page-size="10"
            layout="total, sizes, prev, pager, next, jumper"
            :total="dataList.length">
            </el-pagination>
        </div>
        <el-row>
            <el-col :offset="10" :xs="4" :sm="4" :md="4" :lg="4"  style="margin-top:5px">
                <el-button type="primary" style="width:100%" @click="onSubmit">提  交</el-button>
            </el-col>
        </el-row>
    </div>
</template>
<style>
    .image {
        width: 100%;
        display: block;
    }
    .numberPage {
        margin-top: 20px;
        text-align: center !important;
    }
</style>

<script>
    import store from '../../../../store/store'
    import axios from 'axios'
    export default {
        name:'PrintSerialNumber',
        data(){
            return {
                dataList:[],
                barcodeStyle:'1',
                selectInput:'',
                select:null,
                copiesNum:1,
                tableNumber:null,
                currentPage:1,//默认第一页
                pageSize:10,//默认10条
                getRowKeys(row) {
                    return row.id;
                },
            }
        },
        inject:['reload'],
        create(){
            this.loadData()
        },
        activated() {
            this.dataList=[];
            this.loadData()
        }, 
        // watch:{
        //     data1:{
        //         handler:(newValue,oldValue) => {
        //             console.log('age的newValue值为：'+newValue+'，旧值为:'+oldValue);
        //         },
        //         deep: true 
        //     }
        // },
        methods:{
            loadData(){
                let _this=this
                _this.select = _this.$store.state.serialArr
                _this.tableNumber = _this.select.length;
                for(let i=0;i<_this.select.length;i++){

                    let selectData = {}
                    selectData.productwoid = _this.select[i].id;
                    selectData.type = "pdfinish"
                    axios({
                        method: 'post',
                        url: _this.$store.state.defaultHttp+_this.$store.state.serial+'selectByCriteria',
                        data:selectData,
                    }).then(function(res){
                        let resList=res.data.result.records;
                        for(let z=0;z<resList.length;z++){
                            let List={};
                            List.No =resList[z].snnum//序列号
                            List.Name=_this.select[i].productname//品名
                            List.GNo=_this.select[i].productnum//料号
                            List.Color = _this.select[i].productcolor//颜色
                            List.productmodel = _this.select[i].productmodel//型号
                            List.productwoid =  _this.select[i].id//单据id
                            List.Remark = _this.select[i].productspec;//备注
                            List.id = resList[z].id//序列号id
                            List.quantity = _this.select[i].quantity//记录数
                            _this.dataList.push(List)
                        } 
                    }).catch(function(err){
                    console.log(err)
                    })
                }
            },
            onSubmit(){
                let _this=this
                if(_this.multipleSelection == undefined){
                    _this.$message({
                        message: '请选择需要打印的序列号',
                        type: 'warning'
                    });
                    return
                }
                if(_this.multipleSelection.length == 0 ){
                    _this.$message({
                        message: '请选择需要打印的序列号',
                        type: 'warning'
                    });
                    return
                }
                
                var serialLength = _this.multipleSelection[0].No.length;//第一个序列号长度
                var allData = [];
                var serialPrintNum = [];//对应单据打印的序列号数量
                for(var i = 0; i < _this.multipleSelection.length; i++) {
                    if(_this.multipleSelection[i].No.length != serialLength) {
                            _this.$message({
                                type: 'Danger',
                                message: '序列号['+_this.multipleSelection[i].No+']长度不对!'
                            });
                        return;
                    }
                    _this.multipleSelection[i].Type = _this.barcodeStyle*1;
                    _this.multipleSelection[i].clicked = true;
                    for (var j = 0; j < _this.copiesNum; j++) {//根据打印份数，复制序列号
                        var obj = _this.multipleSelection[i];
                        allData.push(obj);
                    }
                    var productwoid =  _this.multipleSelection[i].productwoid;

                    var flag = false;
                    for(var k = 0; k < serialPrintNum.length; k++) {
                        if(serialPrintNum[k].productwoid == productwoid) {
                            //单据已存在serialPrintNum中
                            flag = true;
                            serialPrintNum[k].num++;
                        }
                    }
                    if(!flag) {//单据未存在serialPrintNum中
                        var obj = {};
                        obj.productwoid = productwoid;
                        obj.num = 1;
                        serialPrintNum.push(obj);
                    }

                }
                window.external.ClickPrint(JSON.stringify(allData));
                var printIds = [];
                // //判断单据序列号的数量和打印的序列号数量是否一致
                for(var i = 0; i <  _this.select.length; i++) {
                    var id =  _this.select[i].id;
                    var quantity =  _this.select[i].quantity;
                    for(var j = 0; j < serialPrintNum.length; j++) {
                        if(serialPrintNum[j].productwoid == id && serialPrintNum[j].num == quantity) {
                            var printId = {};
                            printId.id = id;
                            printId.otherColumn1 = "snnum";
                            printIds.push(printId);
                        }
                    }
                }
                axios({
                        method: 'post',
                        url: _this.$store.state.defaultHttp+_this.$store.state.productWoUrl+'updateStatus',
                        data:JSON.stringify(printIds),
                    }).then(function(res){
                        if(res.data.code == 200){
                            _this.$message({
                                type: 'success',
                                message: '打印序列号条码成功'
                            });
                            this.loadData()
                            _this.$router.push('/ProductioWorkOrder');
                        }else{
                           _this.$message({
                                type: 'Danger',
                                message: res.data.message
                            }); 
                        }
                }).catch(function(err){
                    console.log(err)
                })
            },
            handleSelectionChange(val) {
                this.multipleSelection = val;
            },
            handleSizeChange(val) {
               this.pageSize = val
                
            },
            handleCurrentChange(val) {
               this.currentPage = val
            },
        },
        
    }
</script>
